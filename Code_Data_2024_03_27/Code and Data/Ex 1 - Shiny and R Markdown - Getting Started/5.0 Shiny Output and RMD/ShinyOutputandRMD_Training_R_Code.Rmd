---
title: "Using Shiny Output in R Markdown"
output: html_document
runtime: shiny
---

<sub>
  Accel2R - Clinical R Training <br>
  Â© 2021 Experis ManpowerGroup Inc. All rights reserved
</sub>

```{r setup, include=FALSE}
# Packages & Functions on Display:
# - {shiny 1.6.0}:  selectInput, reactive, renderPlot, plotOutput 


# Set default RMarkdown options for entire document
knitr::opts_chunk$set(
  echo    = FALSE,     # Toggle R code display in final document
  message = FALSE,     # Toggle R function messages in final document
  warning = FALSE,     # Toggle R warnings in final document
  error   = FALSE)     # Toggle R errors in final document

# Load Packages
library(shiny)
library(tidyverse)
```

### Getting Started

- Remember:
  - <i>You</i> can use <b>HTML</b> directly in my <code>rmarkdown</code> document
  - Use `markdown` shortcuts for common HTML styling like *italics* and **bold**
  - `Run` button to submit code to console
  - Help Menu > Markdown Quick Reference
  - Shortcut to insert code chunk: `Ctrl+Alt+I` / `Cmd+Option+I`
  
- Shiny
  - Notice `runtime: shiny` in RMD header
  - `Run Document` replaces `Knit`
  - R Markdown options control if output displays in Viewer or Pop-Up Window
  - Output is not "portable"
  - Document runs on a server (temporary/permanent)
  - R Markdown is 'busy' while document is running

- Previous Lesson
  - Reactive programming

---

### Shiny Output

```{r shiny-select}
shiny::selectInput(
  inputId  = 'select_var',
  label    = 'Select A Variable',
  choices  = colnames(mtcars),
  multiple = FALSE
)
```

- You selected <b>`r reactive(input$select_var)`</b>
- The mean value is <i>`r reactive(mtcars[[input$select_var]] %>% mean() %>% round(2))`</i>
- Here's a histogram: `r reactive(mtcars[[input$select_var]] %>% hist())`

--- 

### Output a Graph

- There are five steps to be aware of when capturing user input and displaying results
- The distinction lies between what is done on the HTML UI and what is done on the R server
- Shiny creates two temporary global variables:
  - `input` contains information that comes from the user interface for use in the R computation server
  - `output` information that comes from the R computation server and pushes to the user interface browser

```{r shiny-graph, echo = TRUE}
# 1. The selection input above is rendered in HTML on the user interface

# 2. Create reactive context to capture user input 'events'
reactive_data_subset <- reactive(mtcars[[input$select_var]])

# 3. Create reactive context that depends on 'events' generated by user input
reactive_histogram <- reactive(reactive_data_subset() %>% hist())

# 4. Renders the plot and places it in the output 'buffer' temporarily
output$reactive_hist_output <- renderPlot(reactive_histogram())

# 5. Push rendered plot to user interface from output buffer
shiny::plotOutput('reactive_hist_output')
```

--- 

### Output a `ggplot` Plot

```{r shiny-select-2}
shiny::selectInput(
  inputId  = 'select_var_ggplot',
  label    = 'Select A Variable',
  choices  = colnames(mtcars),
  multiple = FALSE
)
```

```{r shiny-ggplot, echo = TRUE}
renderPlot(
  mtcars %>% 
    ggplot(aes_string(input$select_var_ggplot)) +
    geom_histogram()
)
```

Some Notes:

- Because Shiny input is always a string or numeric value, special consideration has to be taken when using `tidyverse` packages
  - In ggplot, we use `aes_string` to accept character input
  - Learn more in the "Tidy Evaluation" chapter of [Mastering Shiny](https://mastering-shiny.org/action-tidy.html)
- Notice here we can skip some of the `reactive` steps because the `render` functions are also reactive
- Notice we can skip the `plotOutput` function here because `rmarkdown` makes some assumptions about what we are trying to do
  - **Be Aware**: We won't be able to skip this step in a stand-alone Shiny application

--- 

### Output a Table

Remember in R Markdown we can use `knitr::kable`, `DT::datatable`, `gt::gt`, `reactable::reactable` to output standard HTML tables.

```{r table-r, echo = TRUE}
mtcars %>% DT::datatable(options = list(pageLength = 3))
```

--- 

But when we want a table that changes based on user input, we use a Shiny `reactive`/`render` environment.

```{r table-shiny-select}
shiny::selectInput(
  inputId  = 'select_vars_for_table',
  label    = 'Select Some Variables',
  choices  = colnames(mtcars),
  multiple = TRUE
)
```

```{r table-shiny-display, echo = TRUE}
DT::renderDataTable(
  mtcars %>% 
    select(one_of(input$select_vars_for_table)) %>% 
    DT::datatable(options = list(pageLength = 3))
)
```

---

### References

Render Functions | Output Functions      | Use Case
-----------------|-----------------------|-------------------------------
`renderText`     |  `textOutput`         | Displays formatted text output
`renderPrint`    |  `verbatimTextOutput` | Displays formatted text output 
`renderPlot`     |  `plotOutput`         | Displays base/ggplot2 plots
`renderTable`    |  `tableOutput`        | Displays table output
`renderImage`    |  `imageOutput`        | Displays images from a file
`renderUI`       |  `uiOutput`           | Dynamically update the user interface

---

<b>External Packages</b>

- `DT`: Displays tables with the DataTable JavaScript library
  - `renderDataTable` / `dataTableOutput`
- `gt`: Displays tables with custom styling
  - `render_gt` / `gt_output`
- `reactable`: Displays interactive tables
  - `renderReactable` / `reactableOutput`
- `plotly`: Create interactive graphics
  - `renderPlotly` / `plotlyOutput`
- `flexdashboard`
  - Create R Markdown dashboards, optionally inlcuding Shiny

---

<b>Website Links</b>

- [Site: Using Shiny in RMarkdown](http://rmarkdown.rstudio.com/authoring_shiny.html)
- [Site: RStudio Shiny Tutorial](https://shiny.rstudio.com/tutorial/)
- [Site: RStudio Shiny Cheatsheet](https://rstudio.com/resources/cheatsheets/)
- [Site: RStudio Shiny Reference](https://shiny.rstudio.com/reference/shiny/1.6.0/)

- [Book: Mastering Shiny](https://mastering-shiny.org/)
  - [Chapter: Tidy Evaluation](https://mastering-shiny.org/action-tidy.html)
